---

- name: "Skapa /version/deploy.repo_name"
  become: yes
  file:
    path: "{{ application.path }}/versions/{{ deploy.repo_name | mandatory }}"
    state: directory
    owner: "{{ application.process_user }}"
    group: "{{ application.process_group }}"
    mode: "u=rwx,g=rx,o=rx"

- name: "Uppdatera deploy_facts med [deploy.repo_name].source" 
  set_fact:
    deploy_facts: >-
      {{- deploy_facts | combine({
        deploy.repo_name: {
            'source': application.path+'/versions/'+deploy.repo_name+'/'+deploy_facts[deploy.repo_name].version
          }
        }
        , recursive=True) -}}

#- debug:
#    var: deploy_facts
#- pause:

#setype: httpd_sys_rw_content_t om nginx ska skriva...

- name: "Kopiera filer till /versions"
  become: yes
  become_user: "{{ application.process_user }}"
  # Don't use cp, rsync is easier with exclude-list
  #cp -r 'web'/ "${DEPLOY_PATH}_${DEPLOY_TAG}"
  
  #rsync:
  #-a, --archive               archive mode; equals -rlptgoD (no -H,-A,-X)
  #  -r, --recursive             recurse into directories
  #  -l, --links                 copy symlinks as symlinks
  #  -p, --perms                 preserve permissions
  #  -t, --times                 preserve modification times
  #  -g, --group                 preserve group
  #  -o, --owner                 preserve owner (super-user only)
  #  -D                          same as --devices --specials
  #    --devices               preserve device files (super-user only)
  #    --specials              preserve special files
  
  #  -H, --hard-links     This tells rsync to look for hard-linked files in the transfer and link together the corresponding files on the receiving side. Without this option, hard-linked files in the transfer are treated as though they were separate files.
  #  -A, --acls           This option causes rsync to update the destination ACLs to be the same as the source ACLs. The option also implies --perms.
  #  -X, --xattrs         This option causes rsync to update the remote extended attributes to be the same as the local ones.
  
  #-v, --verbose
  #-z, --compress              compress file data during the transfer
  shell: "rsync -a --delete {{ '--exclude-from '+dq+deploy.exclude_list_file+dq+' ' if deploy.exclude_list_file is defined else '' }}'{{ deploy.folder_to_copy }}'/ \"{{ deploy_facts[deploy.repo_name].source }}\""
  args:
    chdir: "{{ deploy_facts[deploy.repo_name].repo_source }}"
  vars:
    dq: >-
      "
