#!/bin/bash
#
# Generated by Ansible
#

#Exit on errors:
set -e

if [ ! "$(whoami)" == "{{ item.process_user }}" ] ; then
  echo "Run as user {{ item.process_user }} please"
  exit 1
fi

cd {{ item.path }}/deploy/workspace/{{ item.repo_slug }}

# Look in the .hg/hgrc to see key-file.
hg pull
hg update {{ item.repo_branch | default('default') }}

{% if item.pull_and_deploy_script == 'files' %}
  {% for instance in item.dirs_to_sync %}

echo "Syncing {{ instance }}/"
rsync -av --delete {{ instance }}/ {{ item.path }}/{{ instance }}

  {% endfor %}
exit 0
{% elif item.pull_and_deploy_script == 'maven-jetty' %}

mvn clean verify

if [ ! -f "{{ item.path }}/deploy/workspace/last_checksums.csv" ] || ! diff -q "{{ item.path }}/deploy/workspace/last_checksums.csv" "{{ item.path }}/deploy/workspace/{{ item.repo_slug }}/target/checksums.csv" >/dev/null
then
  echo "Deploy {{ item.name }}."
  rm -vfr "{{ item.path }}/webapp/"*
  rm -vf {{ item.path }}/deploy/workspace/last_checksums.csv
  cp -v "{{ item.path }}/deploy/workspace/{{ item.repo_slug }}/target/checksums.csv" "{{ item.path }}/deploy/workspace/last_checksums.csv"
  cp -v "{{ item.path }}/deploy/workspace/{{ item.repo_slug }}/target/dependency/jetty-runner.jar" "{{ item.path }}/webapp"
  cp -v "{{ item.path }}/deploy/workspace/{{ item.repo_slug }}/target/"*.war "{{ item.path }}/webapp/web.war"
  # Exit with 0, trigger restart of jetty-service
  exit 0
fi
echo "No change, will not deploy {{ item.name }}."
# Exit with 1, nothing done.
exit 1

{% endif %}