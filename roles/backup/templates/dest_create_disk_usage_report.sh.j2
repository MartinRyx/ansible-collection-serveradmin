#!/bin/bash
#
# Generated by Ansible
#
# Andringar i denna fil ska goras via Ansible, annars skrivs de over. / Lasse
#

REPORT_FILE="{{ backupinstance.dest.root }}/log/disk_usage_report-{{ backupinstance.name }}.txt"

PATH="{{ backupinstance.dest.root }}/{{ backupinstance.name }}"

echo "Report" $(date -Iseconds | sed -e "s/T/ /") > $REPORT_FILE

echo "$PATH" >> $REPORT_FILE
echo "Growing report:" >> $REPORT_FILE
#du:
# -s, --summarize: display only a total for each argument
# -c, --total: produce a grand total
# -h, --human-readable: print sizes in human readable format (e.g., 1K 234M 2G)
#ls
# -d, --directory: list directories themselves, not their contents
# -v, --sort=version: natural sort of (version) numbers within text (Not 0,1,10,11,2,3...)
# -r, --reverse: reverse order while sorting
du -sch $(ls -dvr "$PATH/*/") >> $REPORT_FILE

echo >> $REPORT_FILE
echo "Disk usage:" >> $REPORT_FILE
du -sch $(ls -dv "$PATH/*/") >> $REPORT_FILE

echo >> $REPORT_FILE
echo "Snapshot-dates:" >> $REPORT_FILE
# xarg-anteckningar
# -n1                 Kör kommandot en gång per rad
# -I @                Ersätt @ med pipad rad i kommanot
# sh -c "...; ...;"   Starta sh och kör kommandona.
#
# echo
# -e                  Kan använda \t och \n
# -n                  Ingen ny rad
(cd "$PATH" && ls -1dv */ | sed -e "s-/--" | xargs -n1 -I @ sh -c 'printf '%-25s' "@"; stat "@" | grep "Modify";')
