#! /bin/bash
# Generated by Ansible
#
# Source: http://www.mad-hacking.net/documentation/linux/reliability/backup/using-rsnapshot-remote.xml
# Source: http://troy.jdmz.net/rsync/#validate-rsync
LOG_ERROR="$(echo ~)/validate-backup-cmd-error.log"
LOG_ACCESS="$(echo ~)/validate-backup-cmd-access.log"

#$SSH_ORIGINAL_COMMAND

echo "$(date "+[%F %T]") $SSH_ORIGINAL_COMMAND" >> "$LOG_ACCESS"

case "$SSH_ORIGINAL_COMMAND" in
*\&*|*\|*|*\;*|*\>*|*\<*|*\!*)
echo "Rejected"
echo "$(date "+[%F %T]") Rejected level 1: $SSH_ORIGINAL_COMMAND" >> "$LOG_ERROR"
exit 1
;;

# Backup:
rsync\ --server\ --sender*)
{# sudo $SSH_ORIGINAL_COMMAND #}
{# $SSH_ORIGINAL_COMMAND #}
# Filer med __nobackup__ i sig ska aldrig gå att ta backup på.
${SSH_ORIGINAL_COMMAND/rsync --server/rsync --exclude '*__nobackup__*' --server}
;;


# Rapportering av lyckad backup:
success\ *)
# Split by ' ' to array
# https://stackoverflow.com/questions/918886/how-do-i-split-a-string-on-a-delimiter-in-bash#tab-top
SUCCESS=($SSH_ORIGINAL_COMMAND)
{% for backupinstance in backup_info.instances.values() | list %}
{%   for destinstance in backupinstance.dest_instances %}
       if [ "${SUCCESS[1]}" = "{{ backupinstance.name }}" ] && [ "${SUCCESS[2]}" = "{{ destinstance.host }}" ]; then
         txtfile="/opt/backup_source/success-{{ backupinstance.name }}-{{ destinstance.host }}.txt"
         echo -n "${SUCCESS[3]}" > "$txtfile"
         chmod +r "$txtfile"
         exit 0
       fi
{%   endfor %}
{% endfor %}
echo "Rejected success report"
echo "$(date "+[%F %T]") Rejected success report: $SSH_ORIGINAL_COMMAND" >> "$LOG_ERROR"
exit 1
;;

#Kör scriptet preparebackup.sh
preparebackup)
{{ backup_info.source_user.home }}/preparebackup.sh
;;

{% if backupscripts.stdout_lines is defined %}
{%   for instance in backupscripts.stdout_lines %}
{{     instance }})
{{     backup_info.source_user.home }}/scripts/{{ instance }}
;;
{%   endfor %}
{% endif %}

*)
echo "Rejected"
echo "$(date "+[%F %T]") Rejected no match: $SSH_ORIGINAL_COMMAND" >> "$LOG_ERROR"
exit 1
;;

esac
